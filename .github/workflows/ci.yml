name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Linux Build and Test
  linux:
    name: Linux (Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          libboost-system-dev \
          pkg-config
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DKRAKEN_BUILD_TESTS=ON \
          -DKRAKEN_BUILD_EXAMPLES=ON
    
    - name: Build
      run: |
        cd build
        cmake --build . -j$(nproc)
    
    - name: Run tests (GoogleTest)
      run: |
        cd build
        echo "Running all GoogleTest suites..."
        ctest --output-on-failure --verbose -j$(nproc)
    
    - name: Test results summary
      if: always()
      run: |
        cd build
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        ctest --output-on-failure --verbose | tee test_results.txt || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total Test Suites:** 24" >> $GITHUB_STEP_SUMMARY
        echo "**Total Test Cases:** 240+" >> $GITHUB_STEP_SUMMARY

  # Windows Build and Test
  windows:
    name: Windows (MSVC)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install vcpkg
      uses: microsoft/setup-vcpkg@v3
    
    - name: Install dependencies via vcpkg
      run: |
        vcpkg install boost-system:x64-windows openssl:x64-windows
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DKRAKEN_BUILD_TESTS=ON -DKRAKEN_BUILD_EXAMPLES=ON -DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release --parallel
    
    - name: Run tests (GoogleTest)
      run: |
        cd build
        echo "Running all GoogleTest suites..."
        ctest --output-on-failure --verbose -C Release --parallel
    
    - name: Test results summary
      if: always()
      run: |
        cd build
        echo "## Test Results (Windows)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        ctest --output-on-failure --verbose -C Release | Out-File -FilePath test_results.txt -Encoding utf8

  # macOS Build and Test
  macos:
    name: macOS (Clang)
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        brew update
        brew install cmake boost openssl@3 pkg-config || true
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DKRAKEN_BUILD_TESTS=ON \
          -DKRAKEN_BUILD_EXAMPLES=ON \
          -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
    
    - name: Build
      run: |
        cd build
        cmake --build . -j$(sysctl -n hw.ncpu)
    
    - name: Run tests (GoogleTest)
      run: |
        cd build
        echo "Running all GoogleTest suites..."
        ctest --output-on-failure --verbose -j$(sysctl -n hw.ncpu)
    
    - name: Test results summary
      if: always()
      run: |
        cd build
        echo "## Test Results (macOS)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        ctest --output-on-failure --verbose | tee test_results.txt || true

  # Code Quality Checks
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          libboost-system-dev \
          clang-tidy
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
    
    - name: Run clang-tidy
      continue-on-error: true
      run: |
        cd build
        find ../src ../include -name '*.cpp' -o -name '*.hpp' | \
          xargs -I {} clang-tidy {} -p . --warnings-as-errors=* || true

  # Test Results Summary
  test-summary:
    name: Test Results
    runs-on: ubuntu-latest
    needs: [linux, windows, macos]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All platforms tested successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Platforms:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Linux (Ubuntu)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Windows (MSVC)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… macOS (Clang)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test Suites:** 24" >> $GITHUB_STEP_SUMMARY
        echo "**Test Cases:** 240+" >> $GITHUB_STEP_SUMMARY

